<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>File Upload with Progress</title>
	</head>
	<body>
		<input type="file" id="fileInput" />
		<button id="uploadButton" onclick="uploadFile()" disabled>Upload</button>
		<progress id="progressBar" value="0" max="100"></progress>

		<script>
			let socket;
			let socketId;

			function connectWebSocket() {
				socket = new WebSocket("ws://localhost:5001/ws");

				socket.onopen = function () {
					console.log("WebSocket connection established");
					document.getElementById("uploadButton").disabled = false;
				};

				socket.onmessage = function (event) {
					// Assuming the first message from the server is the socket ID
					if (!socketId) {
						socketId = event.data;
						console.log("Received socket ID:", socketId);
						return;
					}

					percentValue = parseFloat(event.data);
					document.getElementById("progressBar").innerText = `${Math.floor(percentValue)}%`;

					const progressBar = document.getElementById("progressBar");
					progressBar.value = percentValue;
				};

				socket.onclose = function (event) {
					console.log("WebSocket connection closed:", event.reason);
				};

				socket.onerror = function (error) {
					console.error("WebSocket error:", error);
				};
			}

			function uploadFile() {
				const fileInput = document.getElementById("fileInput");
				const file = fileInput.files[0];

				if (!file) {
					alert("Please select a file first");
					return;
				}

				const formData = new FormData();
				formData.append("chunk", file);

				const xhr = new XMLHttpRequest();
				if (socket === undefined || socketId === "") {
					xhr.open("POST", "/api/v1/storage/upload", true);
				} else {
					xhr.open("POST", "/api/v1/storage/upload?id=" + socketId, true);
				}
				xhr.send(formData);

				xhr.onerror = function () {
					alert("Upload failed due to a network error");
				};

				xhr.onload = function () {
					if (xhr.status == 200) {
						alert("Upload complete");
					} else {
						alert("Upload failed");
					}
				};
			}

			window.onload = function () {
				connectWebSocket();
			};
		</script>
	</body>
</html>
