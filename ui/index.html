<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Medioa - File Upload</title>

		<!-- jQuery -->
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<!-- jQuery -->

		<!-- Bootstrap -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
		<!-- Bootstrap -->

		<!-- Toaster Notification -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.10.0/toastify.min.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.10.0/toastify.min.js"></script>
		<!-- Toaster Notification -->

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
		<!-- Font Awesome -->

		<style>
			body {
				background-color: #f8f9fa;
			}
			.upload-container {
				background-color: #fff;
				padding: 30px;
				border-radius: 10px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
				max-width: 600px;
				margin: 50px auto;
			}
			.progress {
				height: 30px;
				border-radius: 5px;
				overflow: hidden;
			}
			.progress-bar {
				font-weight: bold;
			}
			.file-input {
				border: 2px dashed #ced4da;
				padding: 20px;
				border-radius: 5px;
				text-align: center;
			}
			.file-input input[type="file"] {
				display: none;
			}
			.file-input label {
				display: block;
				cursor: pointer;
				color: #007bff;
			}
			table th {
				font-size: 0.75rem; /* Adjust the size as needed */
				text-align: center;
				vertical-align: middle !important; /* Align text vertically */
			}
			table td {
				font-size: 0.7rem; /* Adjust the size as needed */
				text-align: center;
			}
			.delete-row-btn,
			.refresh-row-btn {
				display: inline-block;
				vertical-align: middle; /* Align buttons vertically */
				margin-right: 5px; /* Adjust spacing between buttons */
			}
			.delete-row-btn i,
			.refresh-row-btn i {
				font-size: 0.875rem; /* Adjust the size of the icons as needed */
			}
			.action-buttons-container {
				white-space: nowrap; /* Prevent buttons from wrapping */
			}
			.tooltip-inner {
				font-size: 14px; /* Adjust tooltip font size */
			}
			.text-danger {
				color: #dc3545;
			}
		</style>
	</head>
	<body>
		<div class="container upload-container">
			<!-- upload section -->
			<h2 class="text-center">Upload a File</h2>
			<form id="uploadForm" enctype="multipart/form-data">
				<div class="form-group file-input">
					<input type="file" id="fileInput" name="file" multiple="false" />
					<label for="fileInput">Click to choose a file</label>
				</div>
				<button type="submit" id="uploadButton" class="btn btn-primary btn-block" disabled>Upload</button>
				<button type="button" id="resetButton" class="btn btn-secondary btn-block mt-2" disabled>Reset</button>
			</form>

			<div class="progress mt-4">
				<div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%">0%</div>
			</div>
			<!-- upload section -->

			<!-- secret section -->
			<div>
				<button
					class="btn btn-link mt-3"
					type="button"
					data-toggle="collapse"
					data-target="#secretCollapse"
					aria-expanded="false"
					aria-controls="secretCollapse"
				>
					Secret
				</button>
				<div class="collapse" id="secretCollapse">
					<div class="card card-body">
						<form id="secretForm">
							<div class="form-group">
								<label for="usernameInput">Username<span class="text-danger">*</span> :</label>
								<input type="text" class="form-control" id="usernameInput" placeholder="Enter username" required />
							</div>
							<div class="form-group">
								<label for="passwordInput">Password<span class="text-danger">*</span> :</label>
								<input type="password" class="form-control" id="passwordInput" placeholder="Enter password" required />
							</div>
							<div class="form-group">
								<label for="pinCodeInput">PIN Code<span class="text-danger">*</span> :</label>
								<input
									id="pinCodeInput"
									class="form-control"
									type="password"
									pattern="[0-9]{4}"
									maxlength="4"
									inputmode="numeric"
									placeholder="Enter PIN code"
									title="PIN code must be 4 digits"
									required
								/>
							</div>
							<div class="form-group">
								<label for="masterKeyInput">Master Key (optional):</label>
								<input type="text" class="form-control" id="masterKeyInput" placeholder="Enter master key" />
							</div>
							<button type="submit" class="btn btn-primary">Save</button>
						</form>
					</div>
				</div>
			</div>
			<!-- secret section -->

			<!-- secret token modal -->
			<div
				class="modal fade"
				id="secretTokenModal"
				tabindex="-1"
				role="dialog"
				aria-labelledby="secretTokenModalLabel"
				aria-hidden="true"
			>
				<div class="modal-dialog modal-dialog-centered" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="secretTokenModalLabel">Secret Token Created</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<p>Please keep your token private.</p>
							<div class="input-group">
								<input type="text" class="form-control" id="secretTokenInput" readonly />
								<div class="input-group-append">
									<button class="btn btn-outline-secondary" type="button" id="copySecretTokenButton">
										<i class="fas fa-copy"></i>
									</button>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
						</div>
					</div>
				</div>
			</div>
			<!-- secret token modal -->

			<!-- secret token input modal -->
			<div
				class="modal fade"
				id="secretTokenInputModal"
				tabindex="-1"
				role="dialog"
				aria-labelledby="secretTokenInputModal"
				aria-hidden="true"
			>
				<div class="modal-dialog modal-dialog-centered" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="secretTokenInputModal">Download Secret File</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<form id="secretForm">
								<div class="input-group">
									<label for="secretTokenInput">Secret token:</label>
									<input type="password" class="form-control" id="secretTokenInput" placeholder="Enter secret" />
								</div>
							</form>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Send</button>
					</div>
				</div>
			</div>
		</div>
		<!-- secret token input modal -->

		<!-- config section -->
		<div>
			<button
				class="btn btn-link mt-3"
				type="button"
				data-toggle="collapse"
				data-target="#configCollapse"
				aria-expanded="false"
				aria-controls="configCollapse"
			>
				Option
			</button>
			<div class="collapse" id="configCollapse">
				<div class="card card-body">
					<div class="form-group">
						<label for="fileNameInput">Enter file name (optional):</label>
						<input type="text" class="form-control" id="fileNameInput" placeholder="Enter new file name" />
						<label for="secretInput" class="mt-3">Secret token (optional):</label>
						<input type="password" class="form-control" id="secretInput" placeholder="Enter your secret token" />
					</div>
				</div>
			</div>
		</div>
		<!-- config section -->

		<div id="downloadLinkContainer" class="mt-3" style="display: none">
			<a id="downloadLink" href="#" class="btn btn-info" target="_blank">Download File</a>
			<button id="copyButton" class="btn btn-warning">Copy to Clipboard</button>
		</div>

		<!-- history section -->
		<div>
			<button
				class="btn btn-link mt-3"
				type="button"
				data-toggle="collapse"
				data-target="#historyCollapse"
				aria-expanded="false"
				aria-controls="historyCollapse"
			>
				History
			</button>
			<div class="collapse" id="historyCollapse">
				<table id="filesTable" class="table mt-5" style="display: none">
					<thead>
						<tr>
							<th>File Name</th>
							<th>Download</th>
							<th>Uploaded At</th>
							<th>Secret</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
		<!-- history section -->

		<script>
			var socket;
			var sessionId;

			function startSession() {
				$.ajax({
					url: "/ws/start",
					// url: "https://medioa.fly.dev/ws/start",
					type: "GET",
					success: function (data) {
						sessionId = data.id;
						console.log("Session ID:", sessionId);
						connectWebSocket(sessionId);
					},
					error: function (xhr, status, error) {
						console.error("Error starting session:", error);
					},
				});
			}

			function connectWebSocket(id) {
				// Establish WebSocket connection
				socket = new WebSocket("ws://127.0.0.1:8080/ws/" + id);
				// socket = new WebSocket("wss://medioa.fly.dev/ws/" + id);
				if (!socket) {
					return;
				}

				socket.onopen = function () {
					showNotificationWS("Medioa connected");
					$("#progressBar").css("width", "0%");
					$("#uploadButton").prop("disabled", false);
					$("#resetButton").prop("disabled", false);
				};

				socket.onmessage = function (event) {
					percentValue = parseFloat(event.data);
					if (percentValue >= 100) {
						percentValue = 100;
					}
					$("#progressBar").css("width", percentValue + "%");
					$("#progressBar").text(Math.floor(percentValue) + "%");
				};

				socket.onclose = function (event) {
					showErrorWS("Medioa disconnected, reconnecting...");
					$("#uploadButton").prop("disabled", true);
					$("#resetButton").prop("disabled", true);

					// Attempt to reconnect after a short delay
					setTimeout(function () {
						connectWebSocket();
					}, 3000);
				};

				// socket.onerror = function (error) {
				// 	showError("WebSocket error:", error);
				// };
			}

			$("#fileInput").change(function () {
				if (this.files.length > 1) {
					showNotification("Please select only one file.");
					this.value = ""; // Clear the input
					$('label[for="fileInput"]').text("Click to choose a file");
					return;
				}

				var fileName = getFileName(this.value);
				if (fileName) {
					$('label[for="fileInput"]').text(fileName);
				} else {
					$('label[for="fileInput"]').text("Click to choose a file");
				}
			});

			$("#uploadForm").on("submit", function (event) {
				event.preventDefault();

				var fileName = $("#fileNameInput").val();
				var secret = $("#secretInput").val();
				var fileInput = $("#fileInput")[0];
				if (fileInput.files.length === 0) {
					showNotification("Please select a file.");
					return;
				}

				var maxSize = 20 << 20; // 20 MB
				if (fileInput.files[0].size > maxSize) {
					showError(`File size exceeds the limit of ${maxSize >> 20} MB`);
					return;
				}

				var formData = new FormData();
				formData.append("chunk", fileInput.files[0]);
				formData.append("file_name", fileName);

				var endpoint;
				if (socket === undefined || sessionId === "") {
					if (secret === "") {
						endpoint = "/api/v1/storage/upload";
					} else {
						endpoint = `/api/v1/storage/secret/upload?secret=${secret}`;
					}
				} else {
					if (secret === "") {
						endpoint = `/api/v1/storage/upload?id=${sessionId}`;
					} else {
						endpoint = `/api/v1/storage/secret/upload?id=${sessionId}&secret=${secret}`;
					}
				}

				$.ajax({
					url: endpoint,
					type: "POST",
					data: formData,
					contentType: false,
					processData: false,
					success: function (response) {
						if (response.error) {
							showError(`${response.error.code}: ${response.error.message}`);
							return;
						}
						showSuccess("File uploaded successfully.");
						var fileId = response.data.file_id;
						var fileName = response.data.file_name;
						var apiDownloadUrl = response.data.url;
						if (secret === "") {
							$.ajax({
								url: response.data.url,
								type: "GET",
								success: function (downloadResponse) {
									var actualDownloadUrl = downloadResponse.data.url;
									var uploadedAt = new Date().toLocaleString();

									// Save file info to local storage
									var hasSecret = false;
									saveFileToLocalStorage(fileId, fileName, apiDownloadUrl, actualDownloadUrl, uploadedAt, hasSecret);

									// Update the table
									addFileToTable(fileId, fileName, apiDownloadUrl, actualDownloadUrl, uploadedAt, hasSecret);
								},
								error: function () {
									showError("An error occurred while retrieving the download link.");
								},
							});
						} else {
							// Save file info to local storage
							var hasSecret = true;
							saveFileToLocalStorage(fileId, fileName, apiDownloadUrl, "", uploadedAt, hasSecret);

							// Update the table
							addFileToTable(fileId, fileName, apiDownloadUrl, "", uploadedAt, hasSecret);
						}
					},
					error: function () {
						showError("An error occurred while uploading the file.");
					},
				});

				// reset
				$("#resetButton").trigger("click");
				$("#downloadLink").attr("href", actualDownloadUrl);
				$("#downloadLinkContainer").show();
			});

			$("#secretForm").submit(function (event) {
				event.preventDefault();

				var username = $("#usernameInput").val().trim();
				var password = $("#passwordInput").val().trim();
				var pinCode = $("#pinCodeInput").val().trim();
				var masterKey = $("#masterKeyInput").val().trim();

				// Validate the PIN code format
				if (!/^\d{4}$/.test(pinCode)) {
					showError("PIN Code must be 4 digits.");
					return;
				}

				var formData = {
					username: username,
					password: password,
					pin_code: pinCode,
					master_key: masterKey,
				};

				$.ajax({
					url: "/api/v1/storage/secret",
					type: "POST",
					contentType: "application/json",
					data: JSON.stringify(formData),
					success: function (response) {
						if (response.error) {
							showError(`${response.error.code}: ${response.error.message}`);
							return;
						}

						showSuccess("Secret token created successfully.");
						$("#secretForm")[0].reset();
						$("#secretCollapse").collapse("hide");

						var token = response.data.access_token;
						$("#secretTokenInput").val(token);
						$("#secretTokenModal").modal("show");
					},
					error: function () {
						showError("An error occurred while creating new secret token");
					},
				});
			});

			$("#resetButton").click(function () {
				$("#uploadForm")[0].reset();
				$('label[for="fileInput"]').text("Click to choose a file");
				$("#progressBar").css("width", "0%");
				$("#progressBar").text("0%");
				$("#downloadLinkContainer").hide();
				$("#downloadLink").attr("href", "");
				$("#fileNameInput").val("");
				$("#secretInput").val("");
				$("secretForm")[0].reset();
			});

			$("#copyButton").click(function () {
				var downloadUrl = $("#downloadLink").attr("href");
				navigator.clipboard.writeText(downloadUrl).then(
					function () {
						showNotification("Download link copied to clipboard!");
					},
					function () {
						showError("Failed to copy download link.");
					}
				);
			});

			// Handle copy to clipboard
			$("#copySecretTokenButton").click(function () {
				var secretTokenInput = $("#secretTokenInput");
				secretTokenInput.select();
				document.execCommand("copy");
				showNotification("Token copied to clipboard");
			});

			function getFileName(fileName) {
				fileName = fileName.split("\\").pop();
				return fileName;
			}
			function saveFileToLocalStorage(fileId, fileName, downloadApi, downloadLink, uploadedAt, hasSecret) {
				var files = JSON.parse(localStorage.getItem("uploadedFiles")) || [];
				files.push({ fileId, fileName, downloadApi, downloadLink, uploadedAt, hasSecret });
				localStorage.setItem("uploadedFiles", JSON.stringify(files));
			}
			function updateFileDownloadLinkFromLocalStorage(fileId, downloadLink) {
				var files = JSON.parse(localStorage.getItem("uploadedFiles")) || [];
				files.forEach(function (file) {
					if (file.fileId === fileId) {
						file.downloadLink = downloadLink;
					}
				});
				localStorage.setItem("uploadedFiles", JSON.stringify(files));
			}
			function deleteFileFromLocalStorage(fileId) {
				var files = JSON.parse(localStorage.getItem("uploadedFiles")) || [];
				files = files.filter(function (file) {
					return file.fileId !== fileId;
				});
				localStorage.setItem("uploadedFiles", JSON.stringify(files));
			}
			function loadFilesFromLocalStorage() {
				var files = JSON.parse(localStorage.getItem("uploadedFiles")) || [];
				files.forEach(function (file) {
					addFileToTable(file.fileId, file.fileName, file.downloadApi, file.downloadLink, file.uploadedAt, file.hasSecret);
				});
			}
			function addFileToTable(fileId, fileName, downloadApi, downloadLink, uploadedAt, hasSecret) {
				var row = `<tr>
					<td style="display:none;">${fileId}</td>
                    <td>${fileName}</td>
                    <td>
                        <a href="${downloadLink}" target="_blank">link</a>
                    	<i class="fas fa-copy copy-url-icon" style="cursor: pointer;" data-url="${downloadLink}"></i>
                    </td>
                    <td>${uploadedAt}</td>
					<td>${hasSecret ? "Yes" : "No"}</td>
                    <td>
						<div class="action-buttons-container">
							<button class="btn btn-info refresh-row-btn" data-toggle="tooltip" title="Refresh link"><i class="fas fa-sync-alt"></i></button>
							<button class="btn btn-danger delete-row-btn" data-toggle="tooltip" title="Delete"><i class="fas fa-trash-alt"></i></button>
        				</div>
                    </td>
                </tr>`;

				$("#filesTable tbody").append(row);
				$("#filesTable").show();

				// Attach event listeners to new buttons
				$(".copy-url-icon")
					.last()
					.click(function () {
						var url = $(this).data("url");
						copyClipboard(url);
					});

				$(".refresh-row-btn")
					.last()
					.click(function () {
						var row = $(this).closest("tr");
						var fileId = row.find("td:first").text();

						$.ajax({
							url: downloadApi,
							type: "GET",
							success: function (downloadResponse) {
								var actualDownloadUrl = downloadResponse.data.url;
								console.log("Actual download link:", actualDownloadUrl);

								// Update download link in local storage
								updateFileDownloadLinkFromLocalStorage(fileId, actualDownloadUrl);

								// Update the table
								row.find("td:nth-child(2) a").attr("href", actualDownloadUrl).text("link");

								// Update copy-url-icon click event
								row.find("td:nth-child(2) i").data("url", actualDownloadUrl);

								showSuccess("Download link refreshed successfully.");
							},
							error: function () {
								showError("An error occurred while refreshing the download link.");
							},
						});
					});

				$(".delete-row-btn")
					.last()
					.click(function () {
						var row = $(this).closest("tr");
						var fileId = row.find("td:first").text();
						deleteFileFromLocalStorage(fileId);
						row.remove();
						if ($("#filesTable tbody tr").length === 0) {
							$("#filesTable").hide();
						}
					});
			}
			function copyClipboard(text) {
				navigator.clipboard.writeText(text).then(
					function () {
						showNotification("Copied to clipboard!");
					},
					function () {
						showError("Failed to copy to clipboard.");
					}
				);
			}
			function showNotification(message) {
				Toastify({
					text: message,
					duration: 3000,
					close: true,
				}).showToast();
			}
			function showNotificationWS(message) {
				Toastify({
					position: "center",
					text: message,
					duration: 1500,
					close: false,
				}).showToast();
			}
			function showErrorWS(message) {
				Toastify({
					position: "center",
					text: message,
					duration: 1500,
					close: false,
					backgroundColor: "red",
				}).showToast();
			}
			function showError(message) {
				Toastify({
					text: message,
					duration: 3000,
					close: true,
					backgroundColor: "red",
				}).showToast();
			}
			function showSuccess(message) {
				Toastify({
					text: message,
					duration: 3000,
					close: true,
					backgroundColor: "green",
				}).showToast();
			}

			$(document).ready(function () {
				// Load files from local storage on page load
				loadFilesFromLocalStorage();
				$('[data-toggle="tooltip"]').tooltip();
				startSession();
			});
		</script>
	</body>
</html>
