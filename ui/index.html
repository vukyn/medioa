<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>File Upload with Progress</title>
		<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	</head>
	<body>
		<input type="file" id="fileInput" />
		<button id="uploadButton" onclick="uploadFile()" disabled>Upload</button>
		<progress id="progressBar" value="0" max="100"></progress>

		<script>
			var socket = io();

			socket.on("connect", () => {
				console.log("Connected to server with id", socket);
				document.getElementById("uploadButton").disabled = false;
			});

			socket.on("disconnect", () => {
				console.log("Disconnected from server");
			});

			socket.on("upload_progress", (obj) => {
				const progressBar = document.getElementById("progressBar");
				progressBar.value = obj.percent;
			});

			socket.on("connect_error", (error) => {
				console.error("Connection Error:", error);
			});

			socket.on("error", (error) => {
				console.error("Socket Error:", error);
			});

			function uploadFile() {
				const fileInput = document.getElementById("fileInput");
				const file = fileInput.files[0];

				if (!file) {
					console.log(socket.id);
					alert("Please select a file first");
					return;
				}

				const formData = new FormData();
				formData.append("chunk", file);

				const xhr = new XMLHttpRequest();
				if (socket === undefined || socket.id === "") {
					xhr.open("POST", "http://localhost:5001/api/v1/storage/upload", true);
				} else {
					xhr.open("POST", "http://localhost:5001/api/v1/storage/upload?sid=" + socket.id, true);
				}
				xhr.send(formData);

				xhr.onerror = function () {
					alert("Upload failed due to a network error");
				};

				xhr.onload = function () {
					if (xhr.status == 200) {
						alert("Upload complete");
					} else {
						alert("Upload failed");
					}
				};
			}
		</script>
	</body>
</html>
